<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="htmlTitle">多语言智能单词识记和听写助手</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS 样式保持不变 */
        .card {
            max-width: 800px;
            margin: 20px auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .word-display {
            font-size: 2.5rem;
            text-align: center;
            margin: 20px 0;
        }
        .phonetic {
            font-size: 1.5rem;
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }
        .definition {
            font-size: 1.2rem;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            transition: opacity 0.3s ease;
            margin-bottom: 0; /* 释义本身不需要额外的底部外边距，间距由例句的 margin-top 控制 */
        }
        .example-sentence {
            font-size: 1.1rem;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 5px;
            margin-top: 10px; /* 恢复例句上方的空隙，与原始代码一致 */
            border-left: 4px solid #4682b4;
            transition: opacity 0.3s ease;
        }
        .example-translation {
            font-size: 1rem;
            color: #666;
            font-style: italic;
            margin-top: 8px;
            padding-left: 10px;
            border-left: 2px solid #ccc;
        }
        /* 修复点: 调整 .card-footer 样式以容纳固定按钮 */
        .card-footer {
            background-color: #f8f9fa;
            border-top: 1px solid rgba(0,0,0,.125);
            padding: 15px;
            display: flex; /* 使用 Flexbox 布局 */
            flex-direction: column; /* 垂直堆叠内容 */
            align-items: center; /* 水平居中 */
            gap: 15px; /* 元素间距 */
        }
        .controls {
            /* controls 不再需要 margin-top 或 text-align: center，因为父级已处理 */
            width: 100%; /* 让控制区占据 footer 的全部宽度 */
            max-width: 600px; /* 限制宽度，使其不至于太宽 */
        }
        .progress-container {
            margin-top: 20px;
        }
        #fileInput {
            display: none;
        }
        .creator-info {
            text-align: center;
            font-size: 0.9rem;
            color: #6c757d;
        }
        /* Adjusted the version-badge for better positioning */
        .creator-name-container {
            font-weight: bold;
            color: #2e317c;
            display: inline-flex; /* Use flexbox to align name and badge */
            align-items: center; /* Vertically center them */
        }
        .contact-email {
            color: #2f2f35;
            text-decoration: none;
            transition: all 0.3s;
        }
        .contact-email:hover {
            color: #bb2d3b;
            text-decoration: underline;
        }
        .version-badge {
            background-color: red; /* Changed to red */
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 5px; /* Added margin for spacing */
            /* vertical-align: middle; No longer needed with flexbox */
        }
        .features-box {
            text-align: center;
            margin: 25px 0 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .features-box h5 {
            font-size: 0.95rem;
            color: #495057;
            margin-bottom: 10px;
        }
        .features-box ul {
            padding-left: 20px;
            text-align: left;
            font-size: 0.85rem;
            margin-bottom: 0;
        }
        .features-box li {
            margin-bottom: 5px;
            color: #6c757d;
        }
        .interval-control {
            margin-bottom: 10px;
            text-align: center; /* 居中显示播放间隔控制器 */
        }
        .custom-request {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
            /* font-style: italic; Removed italics */
        }
        .example-play-btn {
            margin-left: 8px;
            font-size: 0.8rem;
            padding: 2px 6px;
        }
        .btn-group-controls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }
        .hidden-content {
            opacity: 0;
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        .visible-content {
            opacity: 1;
            height: auto;
            overflow: visible; /* Ensure content is visible */
            /* 移除 margin: initial; 和 padding: initial; 让元素的原始 margin/padding 生效 */
        }
        .auto-play-buttons {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }
        .tts-settings {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }
        .tts-option {
            margin-bottom: 10px;
        }
        .api-key-input {
            margin-top: 5px;
        }
        .voice-selection {
            margin-top: 10px;
        }
        .loading-spinner {
            display: none;
            color: #007bff;
            margin-left: 10px;
        }
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .voice-option {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .voice-option:hover {
            background-color: #f0f8ff;
            border-color: #007bff;
        }
        .voice-option.selected {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }
        .voice-gender {
            font-size: 0.8em;
            color: #666;
        }
        .voice-engine {
            font-size: 0.7em;
            color: #888;
        }
        /* 自动播放按钮在激活状态下的样式 */
        .btn-warning.active-autoplay {
            background-color: #dc3545; /* 红色表示停止 */
            border-color: #dc3545;
            color: white;
        }
        .btn-warning.active-autoplay:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .download-info-text {
            font-size: 0.85rem;
            color: #6c757d;
            margin-left: 10px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="text-center flex-grow-1" id="appTitle"><i class="fas fa-language"></i>多语言智能单词识记和听写助手</h3>
                <!-- UI Language Selector -->
                <select id="uiLanguageSelect" class="form-select w-auto ms-auto" style="min-width: 120px;">
                    <option value="zh-CN">中文</option>
                    <option value="en-US">English</option>
                </select>
            </div>
            <div class="card-body">
                <div class="tts-settings">
                    <h5 id="ttsSettingsTitle"><i class="fas fa-cog"></i> 语音合成设置</h5>
                    <!-- Only Amazon Polly TTS option remains -->
                    <div class="tts-option">
                        <label class="form-check-label">
                            <input type="radio" name="ttsOption" value="amazon" checked class="form-check-input">
                            <span id="amazonTtsLabel">Amazon Polly（AI语音，已配置后端）</span>
                        </label>
                        <div class="amazon-config">
                            <div class="voice-selection">
                                <label id="selectVoiceLabel">选择音色：</label>
                                <select class="form-control" id="voiceSelect">
                                    <option value="">请先加载音色...</option>
                                </select>
                                <span class="loading-spinner" id="awsLoading" style="margin-left: 10px;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                                <div class="form-check mt-2">
                                    <input type="checkbox" class="form-check-input" id="useNeuralEngine" checked>
                                    <label class="form-check-label" id="useNeuralEngineLabel">使用神经引擎（更自然）</label>
                                </div>
                            </div>
                            <!-- Removed loadAwsVoicesBtn -->
                        </div>
                    </div>
                </div>

                <div class="text-center mb-3">
                    <!-- This selector now exclusively for Polly spoken languages -->
                    <select id="languageSelect" class="form-select" style="width: auto; display: inline-block;">
                        <!-- Options will be dynamically loaded here by populatePollyLanguageSelector -->
                    </select>
                    <!-- Removed pollyLangInfoText based on the revert request -->
                </div>

                <div class="text-center mb-4">
                    <button class="btn btn-primary me-2" id="loadFileBtn">
                        <i class="fas fa-file-excel"></i> <span id="loadFileBtnText">加载Excel单词表</span>
                    </button>
                    <button class="btn btn-outline-primary" id="downloadFileBtn">
                        <i class="fas fa-download"></i> <span id="downloadFileBtnText">下载单词表</span>
                    </button>
                    <span id="downloadInfoText" class="download-info-text">（未加载文件时下载示例单词表）</span>
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                    <!-- New reminder text -->
                    <p id="excelReminderText" class="text-muted mt-2" style="font-size: 0.9rem;"></p>
                </div>
                
                <div id="wordDisplayArea" style="display: none;">
                    <div class="word-display" id="currentWord"></div>
                    <div class="phonetic" id="currentPhonetic"></div>
                    
                    <div class="definition hidden-content" id="currentDefinition"></div>
                    <div class="example-sentence hidden-content" id="exampleSentenceArea">
                        <h6 id="exampleSentenceTitle"><i class="fas fa-comment-dots"></i> 例句:</h6>
                        <div id="exampleSentence"></div>
                        <div id="exampleTranslation"></div>
                        <button class="btn btn-sm btn-outline-primary example-play-btn" id="playExampleBtn">
                            <i class="fas fa-volume-up"></i> <span id="readExampleBtnText">朗读例句</span>
                        </button>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2" id="progressText">0/0</div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="controls">
                    <div class="btn-group-controls">
                        <button class="btn btn-secondary" id="prevBtn">
                            <i class="fas fa-step-backward"></i> <span id="prevBtnText">上一个</span>
                        </button>
                        <button class="btn btn-success" id="playBtn">
                            <i class="fas fa-play"></i> <span id="playBtnText">播放</span>
                        </button>
                        <button class="btn btn-info" id="nextBtn">
                            <i class="fas fa-step-forward"></i> <span id="nextBtnText">下一个</span>
                        </button>
                    </div>
                    
                    <div class="auto-play-buttons">
                        <button class="btn btn-warning" id="autoPlayBtn">
                            <i class="fas fa-sync-alt"></i> <span id="autoPlayBtnText">自动播放</span>
                        </button>
                        <button class="btn btn-warning" id="autoPlayWithExampleBtn">
                            <i class="fas fa-sync"></i> <span id="autoPlayWithExampleBtnText">自动播放（带例句）</span>
                        </button>
                    </div>
                    
                    <div class="form-group interval-control mt-3">
                        <label for="intervalInput" id="intervalLabel">
                            <i class="fas fa-clock"></i> <span id="intervalLabelText">播放间隔(秒):</span>
                        </label>
                        <input type="number" id="intervalInput" class="form-control" value="2" min="1" max="10" style="width: 80px; display: inline-block;">
                    </div>
                </div>
                <div class="creator-info">
                    <p id="creatorInfoP"><i class="fas fa-user-edit"></i> <span id="creatorLabel">创建者：</span><span class="creator-name-container"><span id="creatorNameContent">小满(自律版）</span><span class="version-badge">rednote</span></span></p>
                    <p id="contactInfoP"><i class="fas fa-envelope"></i> <span id="contactLabel">联系方式：</span><a href="mailto:xiaoman0517@yeah.net" class="contact-email">xiaoman0517@yeah.net</a></p>
                    <p id="customRequestText" class="custom-request"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // 将此 URL 替换为你的 API Gateway URL
        const API_GATEWAY_URL = 'https://7c5n6j1469.execute-api.us-east-1.amazonaws.com/dev';
        const LAMBDA_VOICES_URL = `${API_GATEWAY_URL}/voices`; // 用于获取音色列表的端点
        const LAMBDA_SYNTHESIZE_URL = `${API_GATEWAY_URL}/synthesize`; // 用于语音合成的端点

        let wordsData = [];
        let currentIndex = 0;
        let autoPlayTimeoutId = null; // 用于存储自动播放的 setTimeout ID
        let currentAutoPlayMode = 'none'; // 'none', 'wordOnly', 'wordWithExample'
        let allPollyVoices = []; // 全局变量，存储所有 Polly 音色
        const speechSynthesis = window.speechSynthesis; 
        
        // 全局变量用于当前UI语言
        let currentUILanguage = 'zh-CN'; // 默认语言

        // 获取 DOM 元素 (大部分全局元素)
        const htmlTitle = document.getElementById('htmlTitle');
        const loadFileBtn = document.getElementById('loadFileBtn');
        const fileInput = document.getElementById('fileInput');
        const wordDisplayArea = document.getElementById('wordDisplayArea');
        const currentWordElement = document.getElementById('currentWord');
        const currentPhoneticElement = document.getElementById('currentPhonetic');
        const currentDefinitionElement = document.getElementById('currentDefinition');
        const exampleSentenceArea = document.getElementById('exampleSentenceArea');
        const exampleSentenceElement = document.getElementById('exampleSentence');
        const exampleTranslationElement = document.getElementById('exampleTranslation');
        const playExampleBtn = document.getElementById('playExampleBtn');
        const prevBtn = document.getElementById('prevBtn');
        const playBtn = document.getElementById('playBtn');
        const nextBtn = document.getElementById('nextBtn');
        const autoPlayBtn = document.getElementById('autoPlayBtn');
        const autoPlayWithExampleBtn = document.getElementById('autoPlayWithExampleBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const intervalInput = document.getElementById('intervalInput');
        // Removed loadAwsVoicesBtn reference
        const languageSelect = document.getElementById('languageSelect'); // Polly spoken language selector
        const amazonConfigDiv = document.querySelector('.amazon-config'); // This div now contains all relevant Amazon config
        const voiceSelect = document.getElementById('voiceSelect');
        const useNeuralEngineCheckbox = document.getElementById('useNeuralEngine');
        // UI Language selector DOM element
        const uiLanguageSelect = document.getElementById('uiLanguageSelect');
        const selectVoiceLabel = document.getElementById('selectVoiceLabel');
        const excelReminderText = document.getElementById('excelReminderText'); // New DOM element for Excel reminder
        // New DOM element for download button
        const downloadFileBtn = document.getElementById('downloadFileBtn');
        const downloadInfoText = document.getElementById('downloadInfoText'); // New DOM element for download info
        const awsLoading = document.getElementById('awsLoading'); // Added reference for the moved spinner


        // Example word data for download when no file is loaded
        const exampleWordsData = [
            { word: 'Hello', phonetic: '/həˈloʊ/', definition: '用于见面或问候某人时的招呼语', example: 'Hello, how are you today?', exampleTranslation: '你好，你今天怎么样？' },
            { word: 'World', phonetic: '/wɜːrld/', definition: '地球，连同其所有国家和民族', example: 'The world is a beautiful place.', exampleTranslation: '世界是一个美丽的地方。' },
            { word: 'Learn', phonetic: '/lɜːrn/', definition: '通过学习、实践、被教导或经历某事来获取知识或技能', example: 'I want to learn a new language.', exampleTranslation: '我想学习一门新语言。' },
            { word: 'Science', phonetic: '/ˈsaɪəns/', definition: '通过观察和实验，系统研究物理和自然世界结构和行为的智力及实践活动', example: 'Science helps us understand the universe.', exampleTranslation: '科学帮助我们理解宇宙。' },
            { word: 'Computer', phonetic: '/kəmˈpjuːtər/', definition: '一种用于根据可变程序中的指令，通常以二进制形式存储和处理数据的电子设备', example: 'My computer is very fast.', exampleTranslation: '我的电脑速度很快。' },
            { word: 'Knowledge', phonetic: '/ˈɒlɪdʒ/', definition: '一个人通过经验或教育获得的知识、信息和技能；对某个主题的理论或实践理解', example: 'Knowledge is power.', exampleTranslation: '知识就是力量。' },
            { word: 'Success', phonetic: '/səkˈses/', definition: '实现目标或目的', example: 'Hard work is the key to success.', exampleTranslation: '努力工作是成功的关键。' },
            { word: 'Challenge', phonetic: '/ˈtʃælɪndʒ/', definition: '呼吁某人参与竞争性情境或努力做某事', example: 'Facing new challenges helps us grow.', exampleTranslation: '面对新的挑战有助于我们成长。' }, // Fixed typo: TranslatedExample -> exampleTranslation
            { word: 'Explore', phonetic: '/ɪkˈsplɔːr/', definition: '旅行或穿过（不熟悉的国家或地区）以了解或熟悉它', example: 'Let\'s explore new possibilities.', exampleTranslation: '让我们探索新的可能性。' },
            { word: 'Improve', phonetic: '/ɪmˈprūv/', definition: '使或变得更好', example: 'We always strive to improve our skills.', exampleTranslation: '我们总是在努力提升我们的技能。' },
        ];


        // 语言代码到友好名称的映射 (主要用于 Polly spoken languages 的显示)
        const pollyLanguageDisplayNames = {
            'af-ZA': 'Afrikaans (South Africa)',
            'ar-AE': 'Arabic (United Arab Emirates)',
            'ar-SA': 'Arabic (Saudi Arabia)',
            'ca-ES': 'Catalan (Spain)',
            'cmn-CN': 'Chinese, Mandarin (Mainland)',
            'cy-GB': 'Welsh (United Kingdom)',
            'da-DK': 'Danish (Denmark)',
            'de-DE': 'German (Germany)',
            'en-AU': 'English (Australia)',
            'en-GB': 'English (United Kingdom)',
            'en-IN': 'English (India)',
            'en-IE': 'English (Ireland)',
            'en-NZ': 'English (New Zealand)',
            'en-US': 'English (United States)',
            'en-ZA': 'English (South Africa)',
            'es-ES': 'Spanish (Spain)',
            'es-MX': 'Spanish (Mexico)',
            'es-US': 'Spanish (United States)',
            'fi-FI': 'Finnish (Finland)',
            'fr-CA': 'French (Canada)',
            'fr-FR': 'French (France)',
            'hi-IN': 'Hindi (India)',
            'is-IS': 'Icelandic (Iceland)',
            'it-IT': 'Italian (Italy)',
            'ja-JP': 'Japanese (Japan)',
            'ko-KR': 'Korean (South Korea)',
            'nb-NO': 'Norwegian (Bokmål) (Norway)',
            'nl-NL': 'Dutch (Netherlands)',
            'pl-PL': 'Polish (Poland)',
            'pt-BR': 'Portuguese (Brazil)',
            'pt-PT': 'Portuguese (Portugal)',
            'ro-RO': 'Romanian (Romania)',
            'ru-RU': 'Russian (Russia)',
            'sv-SE': 'Swedish (Sweden)',
            'tr-TR': 'Turkish (Turkey)',
            'yue-CN': 'Chinese, Cantonese (Hong Kong)',
            // Adding zh-CN for display consistency, even if Polly uses cmn-CN
            'zh-CN': 'Chinese, Mandarin (Mainland)', 
        };

        // UI 文本翻译字典
        const uiTranslations = {
            'zh-CN': {
                htmlTitle: '多语言智能单词识记和听写助手',
                appTitle: '多语言智能单词识记和听写助手',
                ttsSettingsTitle: '语音合成设置',
                amazonTtsLabel: 'Amazon Polly（AI语音，已配置后端）',
                selectVoiceLabel: '选择音色：',
                useNeuralEngineLabel: '使用神经引擎（更自然）',
                // loadVoicesBtnText: '加载音色', // Removed as button is gone
                loadFileBtnText: '加载Excel单词表',
                downloadFileBtnText: '下载单词表', // New translation key
                downloadInfoText: '（未加载文件时下载示例单词表）', // New translation key for download info
                excelReminder: '请确保表格按照单词、音标、释义、例句和例句翻译这五列的顺序进行组织。',
                exampleSentenceTitle: '例句:',
                readExampleBtnText: '朗读例句',
                prevBtnText: '上一个',
                playBtnText: '播放',
                nextBtnText: '下一个',
                autoPlayBtnText: '自动播放',
                autoPlayWithExampleBtnText: '自动播放（带例句）',
                intervalLabelText: '播放间隔(秒):', // Updated key for consistency
                creatorLabel: '创建者：', // New key
                creatorNameContent: '小满(自律版）', // New key for actual name
                contactLabel: '联系方式：', // New key
                customRequestText: 'Amazon Polly AI语音生成的免费额度有限，接受捐赠用于维护此网页长期正常运行，好心人可私信或来邮申请加本人微信或提供收款码，如有定制需求也欢迎私信或来邮,非常感谢！ ❤️',
                pollyLangInfo: '', // Removed content for this key
                // Auto Play Button States
                autoPlayWordOnlyActive: '<i class="fas fa-pause"></i> 正在自动播放单词',
                autoPlayWordAndExampleActive: '<i class="fas fa-pause"></i> 正在自动播放单词和例句',
                // Messages
                msgNoVoiceSelected: '请先加载并选择一个 Amazon Polly 音色。',
                msgLoadVoicesFailed: '加载音色失败: {error}。请检查控制台获取更多详情。',
                msgApiError: '语音合成失败: {error}。', 
                msgExcelReadFailed: '读取Excel文件失败，请确保文件格式正确。',
                msgNoWorksheet: 'Excel文件中没有找到工作表。',
                msgNoDataInSheet: 'Excel文件中没有找到数据！',
                msgExcelConvertFailed: '将Excel工作表转换为数据失败，请检查数据结构。',
                msgFileReaderError: '文件读取失败，请重试或检查文件权限。',
                msgPleaseLoadExcel: '请先加载Excel单词表！',
                msgBackendNoAudio: '后端响应中未找到 Base64 音频数据。',
                msgApiVoiceListFailed: '无法从 API 获取所有音色列表。状态码: {status}。错误信息: {error}。',
                msgApiVoiceListFormatError: '后端返回的数据格式不正确，缺少音色列表。',
                msgApiVoiceListParseError: '无法解析后端 JSON 响应。错误: {error}。',
                msgLoadingLanguages: '加载语言...',
                msgLoadingVoices: '加载音色...',
                msgSelectLanguage: '选择语言',
                msgLoadFailed: '加载失败',
                msgSelectVoice: '选择音色...',
                msgNoVoicesForLang: '未找到适合当前语言的音色',
                msgNoDataToDownload: '没有可下载的单词数据。请先加载一个单词表。',
                msgNoDownloadSupport: '您的浏览器不支持文件下载。请尝试使用最新版浏览器。'
            },
            'en-US': {
                htmlTitle: 'Multilingual Smart Word Learning & Dictation Assistant',
                appTitle: 'Multilingual Smart Word Learning & Dictation Assistant',
                ttsSettingsTitle: 'Speech Synthesis Settings',
                amazonTtsLabel: 'Amazon Polly (AI Voice, Backend Configured)',
                selectVoiceLabel: 'Select Voice:',
                useNeuralEngineLabel: 'Use Neural Engine (More Natural)',
                // loadVoicesBtnText: 'Load Voices', // Removed as button is gone
                loadFileBtnText: 'Load Excel Word List',
                downloadFileBtnText: 'Download Word List', // New translation key
                downloadInfoText: '(Downloads example word list if no file is loaded)', // New translation key for download info
                excelReminder: 'Please ensure the table is organized in the order of Word, Phonetic, Definition, Example Sentence, and Example Translation (five columns).',
                exampleSentenceTitle: 'Example Sentence:',
                readExampleBtnText: 'Read Example',
                prevBtnText: 'Previous',
                playBtnText: 'Play',
                nextBtnText: 'Next',
                autoPlayBtnText: 'Auto Play',
                autoPlayWithExampleBtnText: 'Auto Play (with Example)',
                intervalLabelText: 'Play Interval (seconds):', // Updated key for consistency
                creatorLabel: 'Created by:', // New key
                creatorNameContent: 'Xiaoman (Self-discipline Edition)', // New key for actual name
                contactLabel: 'Contact:', // New key
                customRequestText: 'Amazon Polly AI voice generation has limited free quota. Donations are welcome to maintain the long-term operation of this webpage. Kindly message or email to request my WeChat or provide payment QR code. Custom requests are also welcome via message or email. Thank you very much! ❤️',
                pollyLangInfo: '', // Removed content for this key
                // Auto Play Button States
                autoPlayWordOnlyActive: '<i class="fas fa-pause"></i> Auto Playing Word',
                autoPlayWordAndExampleActive: '<i class="fas fa-pause"></i> Auto Playing Word & Example',
                // Messages
                msgNoVoiceSelected: 'Please load and select an Amazon Polly voice first.',
                msgLoadVoicesFailed: 'Failed to load voices: {error}. Check console for more details.',
                msgApiError: 'Speech synthesis failed: {error}.', 
                msgExcelReadFailed: 'Failed to read Excel file. Please ensure the file format is correct.',
                msgNoWorksheet: 'No worksheet found in the Excel file.',
                msgNoDataInSheet: 'No data found in the Excel file!',
                msgExcelConvertFailed: 'Failed to convert Excel worksheet to data. Check data structure.',
                msgFileReaderError: 'File reading failed. Please retry or check file permissions.',
                msgPleaseLoadExcel: 'Please load an Excel word list first!',
                msgBackendNoAudio: 'No Base64 audio data found in backend response.',
                msgApiVoiceListFailed: 'Failed to fetch all voice list from API. Status: {status}. Error: {error}.',
                msgApiVoiceListFormatError: 'Backend returned incorrect data format, missing "Voices" array.',
                msgApiVoiceListParseError: 'Failed to parse backend JSON response. Error: {error}。',
                msgLoadingLanguages: 'Loading Languages...',
                msgLoadingVoices: 'Loading Voices...',
                msgSelectLanguage: 'Select Language',
                msgLoadFailed: 'Load Failed',
                msgSelectVoice: 'Select Voice...',
                msgNoVoicesForLang: 'No voices found for the current language',
                msgNoDataToDownload: 'No word data available to download. Please load a word list first.',
                msgNoDownloadSupport: 'Your browser does not support file downloads. Please try using an updated browser.'
            }
        };

        /**
         * Displays a custom message box (currently uses alert) with translated message.
         * @param {string} key The key for the message in uiTranslations.
         * @param {object} [replacements] Optional replacements for placeholders in the message.
         */
        function showMessageBox(key, replacements = {}) {
            let message = uiTranslations[currentUILanguage][key] || key; // Fallback to key if translation not found
            for (const placeholder in replacements) {
                message = message.replace(`{${placeholder}}`, replacements[placeholder]);
            }
            alert(message);
        }

        /**
         * Updates the text and style of auto-play buttons.
         */
        function updateAutoPlayButtonState() {
            if (currentAutoPlayMode === 'wordOnly') {
                autoPlayBtn.innerHTML = uiTranslations[currentUILanguage].autoPlayWordOnlyActive;
                autoPlayBtn.classList.remove('btn-warning');
                autoPlayBtn.classList.add('btn-danger'); // Red for active
                autoPlayWithExampleBtn.innerHTML = `<i class="fas fa-sync"></i> ${uiTranslations[currentUILanguage].autoPlayWithExampleBtnText}`;
                autoPlayWithExampleBtn.classList.remove('btn-danger');
                autoPlayWithExampleBtn.classList.add('btn-warning');
            } else if (currentAutoPlayMode === 'wordWithExample') {
                autoPlayWithExampleBtn.innerHTML = uiTranslations[currentUILanguage].autoPlayWordAndExampleActive;
                autoPlayWithExampleBtn.classList.remove('btn-warning');
                autoPlayWithExampleBtn.classList.add('btn-danger'); // Red for active
                autoPlayBtn.innerHTML = `<i class="fas fa-sync-alt"></i> ${uiTranslations[currentUILanguage].autoPlayBtnText}`;
                autoPlayBtn.classList.remove('btn-danger');
                autoPlayBtn.classList.add('btn-warning');
            } else {
                autoPlayBtn.innerHTML = `<i class="fas fa-sync-alt"></i> ${uiTranslations[currentUILanguage].autoPlayBtnText}`;
                autoPlayBtn.classList.remove('btn-danger');
                autoPlayBtn.classList.add('btn-warning');
                autoPlayWithExampleBtn.innerHTML = `<i class="fas fa-sync"></i> ${uiTranslations[currentUILanguage].autoPlayWithExampleBtnText}`;
                autoPlayWithExampleBtn.classList.remove('btn-danger');
                autoPlayWithExampleBtn.classList.add('btn-warning');
            }
        }

        /**
         * Stops all ongoing auto-play and speech synthesis.
         */
        function stopAutoPlay() {
            if (autoPlayTimeoutId) {
                clearTimeout(autoPlayTimeoutId);
                autoPlayTimeoutId = null;
            }
            currentAutoPlayMode = 'none';
            updateAutoPlayButtonState();
        }

        /**
         * Displays the current word and phonetic, and hides definition and example sentence.
         */
        function displayWordOnly() {
            const currentWord = wordsData[currentIndex];
            if (!currentWord) return;

            currentWordElement.textContent = currentWord.word;
            currentPhoneticElement.textContent = currentWord.phonetic;

            // Hide definition and example
            currentDefinitionElement.classList.add('hidden-content');
            currentDefinitionElement.classList.remove('visible-content');
            currentDefinitionElement.innerHTML = ''; // Clear content
            exampleSentenceArea.classList.add('hidden-content');
            exampleSentenceArea.classList.remove('visible-content');
            exampleSentenceElement.innerHTML = ''; // Clear content
            exampleTranslationElement.innerHTML = ''; // Clear content

            // Show word display area (if previously hidden)
            wordDisplayArea.style.display = 'block';
        }

        /**
         * Displays the current word, phonetic, definition, and example sentence.
         */
        async function displayWordAndExample() {
            const currentWord = wordsData[currentIndex];
            if (!currentWord) return;

            currentWordElement.textContent = currentWord.word;
            currentPhoneticElement.textContent = currentWord.phonetic;

            // Display definition (removed "释义:" prefix)
            if (currentWord.definition) {
                currentDefinitionElement.innerHTML = currentWord.definition; 
                currentDefinitionElement.classList.remove('hidden-content');
                currentDefinitionElement.classList.add('visible-content');
            } else {
                currentDefinitionElement.classList.add('hidden-content');
                currentDefinitionElement.classList.remove('visible-content');
                currentDefinitionElement.innerHTML = '';
            }

            // Display example sentence
            if (currentWord.example) {
                exampleSentenceElement.textContent = currentWord.example;
                exampleTranslationElement.textContent = currentWord.exampleTranslation;
                exampleSentenceArea.classList.remove('hidden-content');
                exampleSentenceArea.classList.add('visible-content');
            } else {
                exampleSentenceArea.classList.add('hidden-content');
                exampleSentenceArea.classList.remove('visible-content');
                exampleSentenceElement.innerHTML = '';
                exampleTranslationElement.innerHTML = '';
            }
            wordDisplayArea.style.display = 'block';
        }

        /**
         * Updates the progress bar and text.
         */
        function updateProgress() {
            if (wordsData.length === 0) {
                progressBar.style.width = '0%';
                progressText.textContent = '0/0';
                return;
            }
            const progress = ((currentIndex + 1) / wordsData.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${currentIndex + 1}/${wordsData.length}`;
        }

        /**
         * Fetches all Polly voices from the backend and populates the language and voice selectors.
         */
        async function loadAllPollyLanguagesAndVoices() {
            languageSelect.innerHTML = `<option value="">${uiTranslations[currentUILanguage].msgLoadingLanguages}</option>`;
            voiceSelect.innerHTML = `<option value="">${uiTranslations[currentUILanguage].msgLoadingVoices}</option>`;
            awsLoading.style.display = 'inline-block'; // Show spinner during voice loading

            try {
                const response = await fetch(LAMBDA_VOICES_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}), 
                });

                console.log('--- Debugging loadAllPollyLanguagesAndVoices ---');
                console.log('API Request URL:', LAMBDA_VOICES_URL);
                console.log('HTTP Response Status Code:', response.status);
                console.log('HTTP Response OK:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Response Not OK:', errorText);
                    throw new Error(uiTranslations[currentUILanguage].msgApiVoiceListFailed
                        .replace('{status}', response.status)
                        .replace('{error}', errorText));
                }

                const data = await response.json();
                if (!data || !Array.isArray(data.Voices)) {
                    console.error('Backend returned incorrect data format or missing "Voices" array:', data);
                    throw new Error(uiTranslations[currentUILanguage].msgApiVoiceListFormatError);
                }

                allPollyVoices = data.Voices; 

                populatePollyLanguageSelector(); 

                const uniqueLanguageCodes = [...new Set(allPollyVoices.map(voice => voice.LanguageCode))];
                if (uniqueLanguageCodes.includes('en-US')) {
                    languageSelect.value = 'en-US';
                } else if (uniqueLanguageCodes.length > 0) {
                    languageSelect.value = uniqueLanguageCodes[0];
                }

                loadVoiceOptionsForSelectedLanguage();

            } catch (error) {
                console.error('Failed to load all Polly languages and voices:', error);
                languageSelect.innerHTML = `<option value="">${uiTranslations[currentUILanguage].msgLoadFailed}</option>`;
                voiceSelect.innerHTML = `<option value="">${uiTranslations[currentUILanguage].msgLoadFailed}</option>`;
                showMessageBox('msgLoadVoicesFailed', { error: error.message });
            } finally {
                awsLoading.style.display = 'none'; // Hide spinner after voice loading
                console.log('--- End Debugging loadAllPollyLanguagesAndVoices ---');
            }
        }

        /**
         * Populates the language selector with Polly-supported languages.
         */
        function populatePollyLanguageSelector() {
            const uniqueLanguageCodes = [...new Set(allPollyVoices.map(voice => voice.LanguageCode))];
            uniqueLanguageCodes.sort(); 

            languageSelect.innerHTML = ''; 

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = uiTranslations[currentUILanguage].msgSelectLanguage;
            languageSelect.appendChild(defaultOption);

            // Populate languageSelect
            uniqueLanguageCodes.forEach(langCode => {
                const option = document.createElement('option');
                option.value = langCode;
                // Use pollyLanguageDisplayNames for translation, or raw code if not found
                option.textContent = pollyLanguageDisplayNames[langCode] || langCode; 
                languageSelect.appendChild(option);
            });
        }

        /**
         * Populates the voice selector based on the currently selected language.
         */
        function loadVoiceOptionsForSelectedLanguage() {
            const lang = languageSelect.value;
            voiceSelect.innerHTML = `<option value="">${uiTranslations[currentUILanguage].msgSelectVoice}</option>`;
            useNeuralEngineCheckbox.disabled = true;
            useNeuralEngineCheckbox.checked = false;

            if (!lang || allPollyVoices.length === 0) {
                return;
            }

            const langVoices = allPollyVoices.filter(voice => 
                voice.LanguageCode === lang
            );

            if (langVoices.length === 0) {
                voiceSelect.innerHTML = `<option value="">${uiTranslations[currentUILanguage].msgNoVoicesForLang}</option>`;
                console.warn(`No Amazon Polly voices found for the current language (${lang}).`);
                return;
            }

            langVoices.sort((a, b) => {
                if (a.Engine === 'neural' && b.Engine !== 'neural') return -1;
                if (a.Engine !== 'neural' && b.Engine === 'neural') return 1;
                return a.Name.localeCompare(b.Name);
            });

            langVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.Id;
                const engineLabel = voice.SupportedEngines.includes('neural') ? 
                                    (currentUILanguage === 'zh-CN' ? '神经' : 'Neural') : 
                                    (currentUILanguage === 'zh-CN' ? '标准' : 'Standard');
                option.textContent = `${voice.Name} (${voice.Gender}) - ${engineLabel}`;
                option.dataset.supportedEngines = JSON.stringify(voice.SupportedEngines);
                voiceSelect.appendChild(option);
            });

            if (langVoices.length > 0) {
                voiceSelect.value = langVoices[0].Id;
                updateNeuralEngineCheckbox(); 
            }
        }

        function updateNeuralEngineCheckbox() {
            const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.supportedEngines) {
                const supportedEngines = JSON.parse(selectedOption.dataset.supportedEngines);
                const supportsNeural = supportedEngines.includes('neural');
                
                useNeuralEngineCheckbox.disabled = !supportsNeural;
                useNeuralEngineCheckbox.checked = supportsNeural; 
            } else {
                useNeuralEngineCheckbox.disabled = true;
                useNeuralEngineCheckbox.checked = false;
            }
        }

        function getCurrentTTSService() {
            return 'amazon'; 
        }

        /**
         * Plays text using Amazon Polly TTS.
         */
        async function playText(text, lang) {
            const correctedLang = lang.replace(/_/g, '-');
            
            const voiceId = voiceSelect.value;
            if (!voiceId) {
                showMessageBox('msgNoVoiceSelected');
                return Promise.reject('No voice selected');
            }

            awsLoading.style.display = 'inline-block'; // Show spinner during TTS requests

            const selectedEngine = useNeuralEngineCheckbox.checked ? 'neural' : 'standard';

            try {
                const response = await fetch(LAMBDA_SYNTHESIZE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        voiceId: voiceId,
                        engine: selectedEngine,
                        languageCode: correctedLang
                    }),
                });

                console.log('--- Debugging playText function (Amazon service) ---');
                console.log('API Request URL:', LAMBDA_SYNTHESIZE_URL); // Log URL for playText
                console.log('Request Body:', {text, voiceId, engine: selectedEngine, languageCode: correctedLang}); // Log body
                console.log('Received HTTP Status:', response.status);
                console.log('Received HTTP Status Text:', response.statusText);
                console.log('Received Content-Type:', response.headers.get('Content-Type'));

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'API request failed (non-JSON error)' }));
                    throw new Error(errorData.message || 'API request failed');
                }

                const responseJson = await response.json();
                const audioBase64 = responseJson.audioBase64;

                if (!audioBase64) {
                    throw new Error('msgBackendNoAudio');
                }
                
                const byteCharacters = atob(audioBase64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const audioBlob = new Blob([byteArray], { type: 'audio/mpeg' });

                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                return new Promise((resolve) => {
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        resolve();
                    };
                    audio.onerror = (e) => {
                        console.error('Audio playback failed:', e.target.error);
                        showMessageBox('msgApiError', { error: 'Audio playback failed' });
                        URL.revokeObjectURL(audioUrl);
                        resolve(); 
                    };
                    audio.play().catch((playError) => {
                        console.error('Audio playback prevented or failed:', playError);
                        showMessageBox('msgApiError', { error: 'Audio playback prevented or failed' });
                        URL.revokeObjectURL(audioUrl);
                        resolve(); 
                    });
                });

            } catch (error) {
                console.error('Backend API call failed:', error);
                showMessageBox('msgApiError', { error: error.message });
                return Promise.reject(error); 
            } finally {
                awsLoading.style.display = 'none'; // Hide spinner after TTS requests
            }
        }

        /**
         * Plays the current word's pronunciation.
         * Logic: Display only word/phonetic, play word, then display definition/example.
         */
        async function playCurrentWord() {
            if (wordsData.length === 0) return;
            const word = wordsData[currentIndex].word;
            const lang = languageSelect.value;
            
            displayWordOnly(); 
            await playText(word, lang); 
            await displayWordAndExample(); 
        }

        /**
         * Converts wordsData or exampleWordsData to CSV format and triggers a download.
         */
        function downloadWordList() {
            let dataToDownload = wordsData.length > 0 ? wordsData : exampleWordsData;
            let fileName = wordsData.length > 0 ? 'my_word_list.csv' : 'example_word_list.csv';

            if (dataToDownload.length === 0) {
                showMessageBox('msgNoDataToDownload');
                return;
            }

            const headers = ['Word', 'Phonetic', 'Definition', 'Example', 'ExampleTranslation'];
            let csvContent = headers.map(header => `"${header}"`).join(',') + '\n';

            dataToDownload.forEach(row => {
                const rowArray = [
                    row.word,
                    row.phonetic,
                    row.definition,
                    row.example,
                    row.exampleTranslation
                ];
                // Escape double quotes and enclose fields in double quotes
                csvContent += rowArray.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',') + '\n';
            });

            // Prepend UTF-8 BOM to resolve garbled characters in Excel
            csvContent = '\uFEFF' + csvContent;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection for download attribute
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                // Fallback for browsers that don't support download attribute
                showMessageBox('msgNoDownloadSupport'); 
            }
        }


        /**
         * Updates all static UI text based on the currentUILanguage.
         */
        function updateUILanguageText() {
            const translations = uiTranslations[currentUILanguage];
            console.log('Updating UI for language:', currentUILanguage);

            htmlTitle.textContent = translations.htmlTitle;
            document.getElementById('appTitle').innerHTML = `<i class="fas fa-language"></i>${translations.appTitle}`;

            // TTS Settings section
            document.getElementById('ttsSettingsTitle').innerHTML = `<i class="fas fa-cog"></i> ${translations.ttsSettingsTitle}`;
            document.getElementById('amazonTtsLabel').textContent = translations.amazonTtsLabel;
            document.getElementById('selectVoiceLabel').textContent = translations.selectVoiceLabel;
            document.getElementById('useNeuralEngineLabel').textContent = translations.useNeuralEngineLabel;
            // Removed loadVoicesBtnText from here

            // File loading
            document.getElementById('loadFileBtnText').textContent = translations.loadFileBtnText;
            document.getElementById('downloadFileBtnText').textContent = translations.downloadFileBtnText; // Update download button text
            const excelReminderTextElement = document.getElementById('excelReminderText');
            if (excelReminderTextElement) { 
                excelReminderTextElement.textContent = translations.excelReminder; 
            } else {
                console.warn('excelReminderText element not found!');
            }
            // Update download info text
            if (downloadInfoText) {
                downloadInfoText.textContent = translations.downloadInfoText;
            } else {
                console.warn('downloadInfoText element not found!');
            }

            // Example Sentence section (title only)
            document.getElementById('exampleSentenceTitle').innerHTML = `<h6><i class="fas fa-comment-dots"></i> ${translations.exampleSentenceTitle}</h6>`;
            document.getElementById('readExampleBtnText').textContent = translations.readExampleBtnText;

            // Controls
            document.getElementById('prevBtnText').textContent = translations.prevBtnText;
            document.getElementById('playBtnText').textContent = translations.playBtnText;
            document.getElementById('nextBtnText').textContent = translations.nextBtnText;
            document.getElementById('autoPlayBtnText').textContent = translations.autoPlayBtnText;
            document.getElementById('autoPlayWithExampleBtnText').textContent = translations.autoPlayWithExampleBtnText;
            
            // Updated intervalLabelText - Get it here
            const intervalLabelTextElement = document.getElementById('intervalLabelText');
            if (intervalLabelTextElement) {
                intervalLabelTextElement.textContent = translations.intervalLabelText;
            } else {
                console.warn('intervalLabelText element not found during updateUILanguageText!');
            }

            // Creator Info - Get elements here
            const creatorLabelElement = document.getElementById('creatorLabel');
            if (creatorLabelElement) {
                creatorLabelElement.textContent = translations.creatorLabel;
            } else {
                console.warn('creatorLabel element not found during updateUILanguageText!');
            }
            const creatorNameContentElement = document.getElementById('creatorNameContent');
            if (creatorNameContentElement) {
                creatorNameContentElement.textContent = translations.creatorNameContent;
            } else {
                console.warn('creatorNameContent element not found during updateUILanguageText!');
            }
            
            const contactLabelElement = document.getElementById('contactLabel');
            if (contactLabelElement) {
                contactLabelElement.textContent = translations.contactLabel;
            } else {
                console.warn('contactLabel element not found during updateUILanguageText!');
            }

            const customRequestTextElement = document.getElementById('customRequestText');
            if (customRequestTextElement) { 
                customRequestTextElement.innerHTML = translations.customRequestText;
                console.log('customRequestText element innerHTML after update:', customRequestTextElement.innerHTML); 
            } else {
                console.warn('customRequestText element not found!');
            }

            // Removed pollyLangInfoText update based on the revert request

            // Update auto play button states (their text might change based on active/inactive)
            updateAutoPlayButtonState();

            // Re-populate Polly spoken language options to use updated UI language for display names
            const currentPollyLang = languageSelect.value;
            populatePollyLanguageSelector(); 
            languageSelect.value = currentPollyLang || ''; 

            loadVoiceOptionsForSelectedLanguage(); 
        }


        document.addEventListener('DOMContentLoaded', function() {
            // Determine initial UI language based on browser preference
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith('en')) {
                currentUILanguage = 'en-US';
                uiLanguageSelect.value = 'en-US';
            } else {
                currentUILanguage = 'zh-CN';
                uiLanguageSelect.value = 'zh-CN';
            }
            updateUILanguageText(); 

            amazonConfigDiv.style.display = 'block';
            selectVoiceLabel.style.display = 'inline-block';
            voiceSelect.style.display = 'inline-block';
            // Removed loadAwsVoicesBtn related display properties

            // Initial load of Polly languages and voices - this will now happen automatically
            loadAllPollyLanguagesAndVoices();
            
            // ADDED: Event listener for the Polly spoken language selector
            languageSelect.addEventListener('change', function() {
                console.log('Polly Spoken Language changed to:', this.value);
                loadVoiceOptionsForSelectedLanguage();
            });

            // Voice selection dropdown change (Polly voice)
            voiceSelect.addEventListener('change', updateNeuralEngineCheckbox);

            // Removed loadAwsVoicesBtn.addEventListener

            // Excel file loading logic remains the same
            fileInput.addEventListener('change', function(e) {
                console.log('--- 开始加载 Excel 文件 ---');
                const file = e.target.files[0];
                if (!file) {
                    console.log('未选择文件或取消选择。');
                    return;
                }
                console.log('已选择文件:', file.name, '类型:', file.type, '大小:', file.size, '字节');

                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('FileReader: 文件读取成功。');
                    const data = new Uint8Array(e.target.result);
                    let workbook;
                    try {
                        workbook = XLSX.read(data, { type: 'array' });
                        console.log('XLSX: 工作簿读取成功。工作表名称:', workbook.SheetNames);
                    } catch (error) {
                        console.error('XLSX: 读取工作簿失败:', error);
                        showMessageBox('msgExcelReadFailed');
                        return;
                    }
                    
                    const firstSheetName = workbook.SheetNames[0];
                    if (!firstSheetName) {
                        console.error('XLSX: 工作簿中没有找到任何工作表名称。');
                        showMessageBox('msgNoWorksheet');
                        return;
                    }
                    console.log('XLSX: 第一张工作表名称:', firstSheetName);

                    const worksheet = workbook.Sheets[firstSheetName];
                    if (!worksheet) {
                         console.error('XLSX: 无法获取第一张工作表。');
                         showMessageBox('msgNoWorksheet'); 
                         return;
                    }
                    console.log('XLSX: 获取工作表成功。工作表范围:', worksheet['!ref']);

                    let jsonData;
                    try {
                        jsonData = XLSX.utils.sheet_to_json(worksheet);
                        console.log('XLSX: 成功将工作表转换为 JSON。数据条目数:', jsonData.length);
                        console.log('XLSX: 转换后的 JSON 数据示例 (前5条):', JSON.stringify(jsonData.slice(0, 5), null, 2));
                    } catch (error) {
                        console.error('XLSX: 将工作表转换为 JSON 失败:', error);
                        showMessageBox('msgExcelConvertFailed');
                        return;
                    }
                    
                    if (jsonData.length > 0) {
                        wordsData = jsonData.map(row => {
                            const keys = Object.keys(row);
                            console.log('Processing raw row data:', row);
                            console.log('Inferred key order:', keys);
                            return {
                                word: row[keys[0]] || '',
                                phonetic: row[keys[1]] || '',
                                definition: row[keys[2]] || '',
                                example: row[keys[3]] || '',
                                exampleTranslation: row[keys[4]] || ''
                            };
                        });
                        console.log('Successfully processed wordsData. Total entries:', wordsData.length);
                        console.log('Processed wordsData example (first 5 entries):', JSON.stringify(wordsData.slice(0, 5), null, 2));
                        
                        wordDisplayArea.style.display = 'block';
                        currentIndex = 0;
                        displayWordOnly();
                        updateProgress();
                    } else {
                        console.warn('No data found in the Excel file! jsonData is empty.');
                        showMessageBox('msgNoDataInSheet');
                    }
                };
                reader.onerror = function(e) {
                    console.error('FileReader: File reading error:', e);
                    showMessageBox('msgFileReaderError');
                };
                reader.readAsArrayBuffer(file);
            });
            
            loadFileBtn.addEventListener('click', function() {
                fileInput.click();
            });

            // Add event listener for the new download button
            downloadFileBtn.addEventListener('click', downloadWordList);

            playExampleBtn.addEventListener('click', function() {
                const currentWord = wordsData[currentIndex];
                if (!currentWord || !currentWord.example) return;
                
                const lang = languageSelect.value;
                playText(currentWord.example, lang);
            });

            playBtn.addEventListener('click', function() {
                if (wordsData.length === 0) { showMessageBox('msgPleaseLoadExcel'); return; }
                stopAutoPlay();
                playCurrentWord();
            });

            prevBtn.addEventListener('click', function() {
                if (wordsData.length === 0) { showMessageBox('msgPleaseLoadExcel'); return; }
                stopAutoPlay();
                
                currentIndex = (currentIndex - 1 + wordsData.length) % wordsData.length;
                displayWordOnly();
                playCurrentWord();
                updateProgress();
            });

            nextBtn.addEventListener('click', function() {
                if (wordsData.length === 0) { showMessageBox('msgPleaseLoadExcel'); return; }
                stopAutoPlay();
                
                currentIndex = (currentIndex + 1) % wordsData.length;
                displayWordOnly();
                playCurrentWord();
                updateProgress();
            });

            autoPlayBtn.addEventListener('click', function() {
                if (wordsData.length === 0) {
                    showMessageBox('msgPleaseLoadExcel');
                    return;
                }
                
                if (currentAutoPlayMode === 'wordOnly') {
                    stopAutoPlay();
                } else {
                    stopAutoPlay();
                    currentAutoPlayMode = 'wordOnly';
                    updateAutoPlayButtonState();
                    startAutoPlay();
                }
            });

            autoPlayWithExampleBtn.addEventListener('click', function() {
                if (wordsData.length === 0) {
                    showMessageBox('msgPleaseLoadExcel');
                    return;
                }
                
                if (currentAutoPlayMode === 'wordWithExample') {
                    stopAutoPlay();
                } else {
                    stopAutoPlay();
                    currentAutoPlayMode = 'wordWithExample';
                    updateAutoPlayButtonState();
                    startAutoPlay();
                }
            });

            async function startAutoPlay() {
                if (wordsData.length === 0 || currentAutoPlayMode === 'none') {
                    stopAutoPlay();
                    return;
                }

                const intervalTime = parseFloat(intervalInput.value) * 1000;
                
                await playCurrentWord();
                
                if (currentAutoPlayMode === 'wordWithExample') {
                    const currentWord = wordsData[currentIndex];
                    if (currentWord && currentWord.example) {
                        await playText(currentWord.example, languageSelect.value);
                    }
                }

                autoPlayTimeoutId = setTimeout(async () => {
                    currentIndex = (currentIndex + 1) % wordsData.length;
                    updateProgress();
                    if (wordsData.length > 0) {
                        startAutoPlay();
                    } else {
                        stopAutoPlay();
                    }
                }, intervalTime + (currentAutoPlayMode === 'wordWithExample' ? 1000 : 0)); 
            }
            
            uiLanguageSelect.addEventListener('change', function() {
                console.log('UI Language changed to:', this.value); 
                currentUILanguage = this.value;
                updateUILanguageText();
                const currentPollyLang = languageSelect.value;
                populatePollyLanguageSelector();
                languageSelect.value = currentPollyLang || ''; 
                loadVoiceOptionsForSelectedLanguage(); 
            });
        });
    </script>
</body>
</html>
